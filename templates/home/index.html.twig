<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Nova 路 Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #c0392b;
            --primary-dark: #962d21;
            --accent: #f9d29d;
            --bg: #fff8f1;
            --text-dark: #2f1b12;
        }
        * { font-family: 'Poppins', 'Segoe UI', sans-serif; }
        body {
            background: radial-gradient(circle at top, rgba(255, 189, 140, 0.4), transparent 50%), var(--bg);
            color: var(--text-dark);
        }
        .brand-badge {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 999px;
            padding: 0.35rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 1.3rem;
            box-shadow: 0 25px 60px rgba(193, 126, 78, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(8px);
        }
        .hero {
            padding: 3rem 2rem 2rem;
        }
        .hero h1 {
            font-size: clamp(2.2rem, 4vw, 3.2rem);
            font-weight: 600;
            line-height: 1.2;
        }
        .pizza-card img {
            border-radius: 1rem;
            height: 150px;
            object-fit: cover;
        }
        .pill {
            border-radius: 999px;
            padding: 0.2rem 0.65rem;
            background: #fff;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        .status-badge {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .cart-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            padding: 0.75rem 0;
        }
    </style>
</head>
<body>
    <main class="container py-4">
        <section class="hero text-center text-md-start">
            <div class="brand-badge mb-3"> Pizza Nova</div>
            <h1>Gestiona pedidos y men煤s en un panel simple y elegante.</h1>
            <p class="text-muted">Inicia sesi贸n con un usuario de prueba, explora el men煤 y lanza pedidos contra la API real.</p>
        </section>

        <section class="row g-4 align-items-stretch mb-4">
            <div class="col-lg-5">
                <div class="glass-card p-4 h-100">
                    <h5 class="mb-3">1 路 Autenticaci贸n</h5>
                    <form id="loginForm" class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="test@example.com" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Contrase帽a</label>
                            <input type="password" class="form-control" id="password" value="password123" required>
                        </div>
                        <div class="col-12 d-grid">
                            <button class="btn btn-primary" type="submit">Iniciar sesi贸n</button>
                        </div>
                        <div class="col-12">
                            <div id="loginStatus" class="status-badge text-center"></div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="glass-card p-4 h-100 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">2 路 Carrito</h5>
                        <span class="pill bg-light" id="userBadge">Sin sesi贸n</span>
                    </div>
                    <div id="cartList" class="flex-grow-1"></div>
                    <div class="d-flex gap-2 mt-3">
                        <button id="sendOrderBtn" class="btn btn-primary flex-grow-1" disabled>Enviar pedido</button>
                        <button id="clearCartBtn" class="btn btn-outline-secondary">Limpiar</button>
                    </div>
                    <button id="currentOrderBtn" class="btn btn-link mt-2 text-decoration-none">Ver pedido pendiente</button>
                    <div id="orderStatus" class="status-badge mt-2"></div>
                </div>
            </div>
        </section>

        <section class="glass-card p-4 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">3 路 Men煤</h5>
                <span class="text-muted" id="menuInfo"></span>
            </div>
            <div id="pizzasGrid" class="row g-4"></div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = `${window.location.origin}/api`;
        const state = { user: null, pizzas: [], cart: [] };

        const loginForm = document.getElementById('loginForm');
        const loginStatus = document.getElementById('loginStatus');
        const userBadge = document.getElementById('userBadge');
        const pizzasGrid = document.getElementById('pizzasGrid');
        const cartList = document.getElementById('cartList');
        const sendOrderBtn = document.getElementById('sendOrderBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const orderStatus = document.getElementById('orderStatus');
        const currentOrderBtn = document.getElementById('currentOrderBtn');
        const menuInfo = document.getElementById('menuInfo');

        const formatCurrency = (value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(parseFloat(value));
        const sizeLabels = { small: 'Peque帽a', medium: 'Mediana', large: 'Grande' };
        const getSizeLabel = (size) => sizeLabels[size?.toLowerCase()] || size;

        function setStatus(el, message, type = 'info') {
            if (!el) return;
            el.textContent = message;
            el.className = `status-badge text-${type}`;
        }

        async function login(event) {
            event.preventDefault();
            setStatus(loginStatus, 'Autenticando...', 'warning');
            const payload = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
            };
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Error');
                state.user = data.data;
                userBadge.textContent = state.user.name || state.user.email;
                setStatus(loginStatus, 'Sesi贸n iniciada correctamente', 'success');
                sendOrderBtn.disabled = state.cart.length === 0;
            } catch (error) {
                state.user = null;
                userBadge.textContent = 'Sin sesi贸n';
                setStatus(loginStatus, error.message, 'danger');
                sendOrderBtn.disabled = true;
            }
        }

        async function loadPizzas() {
            setStatus(menuInfo, 'Cargando pizzas...', 'warning');
            try {
                const res = await fetch(`${API_BASE}/menu/pizzas`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Error');
                state.pizzas = data.data;
                renderPizzas();
                setStatus(menuInfo, `${state.pizzas.length} pizzas disponibles`, 'success');
            } catch (error) {
                setStatus(menuInfo, error.message, 'danger');
            }
        }

        function renderPizzas() {
            pizzasGrid.innerHTML = '';
            state.pizzas.forEach((pizza) => {
                const sizesOptions = pizza.sizes.map((size) => `
                    <option value="${size.size}">${getSizeLabel(size.size)} 路 ${formatCurrency(size.price)}</option>
                `).join('');

                const div = document.createElement('div');
                div.className = 'col-md-6 col-xl-4';
                div.innerHTML = `
                    <div class="pizza-card card border-0 h-100">
                        ${pizza.image_url ? `<img src="${pizza.image_url}" class="card-img-top" alt="${pizza.name}">` : ''}
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">${pizza.name}</h5>
                                <span class="pill">${pizza.category}</span>
                            </div>
                            <p class="text-muted small">${pizza.description || 'Sin descripci贸n'}</p>
                            <div class="mb-2">
                                <label class="form-label small">Tama帽o</label>
                                <select class="form-select" data-size-for="${pizza.id}">
                                    ${sizesOptions}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Cantidad</label>
                                <input type="number" min="1" max="5" value="1" class="form-control" data-qty-for="${pizza.id}">
                            </div>
                            <button class="btn btn-primary w-100" data-add="${pizza.id}">A帽adir al pedido</button>
                        </div>
                    </div>
                `;
                pizzasGrid.appendChild(div);
            });
        }

        function renderCart() {
            if (!state.cart.length) {
                cartList.innerHTML = '<p class="text-muted text-center">Todav铆a no hay pizzas en el pedido.</p>';
                sendOrderBtn.disabled = true;
                return;
            }
            cartList.innerHTML = state.cart.map((item, index) => {
                const pizza = state.pizzas.find((p) => p.id === item.pizza_id);
                const label = pizza ? `${pizza.name} (${getSizeLabel(item.size)})` : `Pizza #${item.pizza_id}`;
                return `
                    <div class="cart-item d-flex justify-content-between align-items-center" data-cart-index="${index}">
                        <div>
                            <strong>${label}</strong>
                            <p class="mb-0 small text-muted">Cantidad: ${item.quantity}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" data-remove="${index}">Eliminar</button>
                    </div>
                `;
            }).join('');
            sendOrderBtn.disabled = !state.user;
        }

        function addToCart(pizzaId) {
            const sizeSelect = document.querySelector(`[data-size-for="${pizzaId}"]`);
            const qtyInput = document.querySelector(`[data-qty-for="${pizzaId}"]`);
            if (!sizeSelect || !qtyInput) return;
            const size = sizeSelect.value;
            const quantity = parseInt(qtyInput.value, 10) || 1;
            const existing = state.cart.find((item) => item.pizza_id === pizzaId && item.size === size);
            if (existing) {
                existing.quantity += quantity;
            } else {
                state.cart.push({ pizza_id: pizzaId, size, quantity });
            }
            renderCart();
            setStatus(orderStatus, 'Pizza a帽adida al pedido', 'success');
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            renderCart();
        }

        function clearCart() {
            state.cart = [];
            renderCart();
            setStatus(orderStatus, 'Pedido vac铆o', 'secondary');
        }

        async function sendOrder() {
            if (!state.user) {
                setStatus(orderStatus, 'Inicia sesi贸n para enviar el pedido', 'danger');
                return;
            }
            if (!state.cart.length) {
                setStatus(orderStatus, 'A帽ade pizzas antes de enviar', 'warning');
                return;
            }
            setStatus(orderStatus, 'Enviando pedido...', 'warning');
            try {
                const res = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: state.user.id, items: state.cart }),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Error');
                clearCart();
                setStatus(orderStatus, `Pedido #${data.data.id} creado correctamente`, 'success');
            } catch (error) {
                setStatus(orderStatus, error.message, 'danger');
            }
        }

        async function fetchCurrentOrder() {
            if (!state.user) {
                setStatus(orderStatus, 'Inicia sesi贸n primero', 'danger');
                return;
            }
            setStatus(orderStatus, 'Buscando pedido pendiente...', 'warning');
            try {
                const res = await fetch(`${API_BASE}/orders/current?user_id=${state.user.id}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Error');
                if (!data.data) {
                    setStatus(orderStatus, 'No hay pedidos pendientes', 'info');
                } else {
                    setStatus(orderStatus, `Pedido #${data.data.id} 路 Estado: ${data.data.status}`, 'success');
                }
            } catch (error) {
                setStatus(orderStatus, error.message, 'danger');
            }
        }

        loginForm.addEventListener('submit', login);
        clearCartBtn.addEventListener('click', clearCart);
        sendOrderBtn.addEventListener('click', sendOrder);
        currentOrderBtn.addEventListener('click', fetchCurrentOrder);

        document.addEventListener('click', (event) => {
            if (event.target.matches('[data-add]')) {
                const pizzaId = parseInt(event.target.getAttribute('data-add'), 10);
                addToCart(pizzaId);
            }
            if (event.target.matches('[data-remove]')) {
                const index = parseInt(event.target.getAttribute('data-remove'), 10);
                removeFromCart(index);
            }
        });

        loadPizzas();
        renderCart();
    </script>
</body>
</html>
